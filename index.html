<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>かな変換テスター｜キー割り当て上書き & プリセット(QWERTY/Dvorak/大西)</title>
  <meta name="description" content="キーボードのキー割り当てを、表示キーのクリック→参照したい物理キーの押下で即時上書き。QWERTY/Dvorak/大西(プレースホルダ)のプリセット切替と、ローマ字→かな変換の動作確認ができるシングルファイルWebツール。" />
  <meta name="robots" content="index, follow, max-image-preview:large" />
  <link rel="canonical" href="https://YOUR_USERNAME.github.io/YOUR_REPO/" /> <!-- ← 公開URLに置換 -->

  <!-- Open Graph -->
  <meta property="og:title" content="かな変換テスター｜キー割り当て上書き & プリセット(QWERTY/Dvorak/大西)" />
  <meta property="og:description" content="クリック→物理キー押下で即時上書き。QWERTY/Dvorak/大西プリセット対応 & ローマ字→かな変換の確認ができるWebツール。" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://YOUR_USERNAME.github.io/YOUR_REPO/" /> <!-- ← 公開URLに置換 -->
  <meta property="og:image" content="https://YOUR_USERNAME.github.io/YOUR_REPO/og-image.jpg" /> <!-- ← 画像URLに置換（1200x630推奨） -->
  <meta property="og:locale" content="ja_JP" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="かな変換テスター｜キー割り当て上書き & プリセット(QWERTY/Dvorak/大西)" />
  <meta name="twitter:description" content="クリック→物理キー押下で即時上書き。プリセット切替 & かな変換確認。" />
  <meta name="twitter:image" content="https://YOUR_USERNAME.github.io/YOUR_REPO/og-image.jpg" />

  <!-- JSON-LD（構造化データ） -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "かな変換テスター",
    "url": "https://YOUR_USERNAME.github.io/YOUR_REPO/",
    "applicationCategory": "UtilitiesApplication",
    "operatingSystem": "All",
    "description": "キー割り当てをクリック→物理キー押下で上書き。QWERTY/Dvorak/大西のプリセット切替と、ローマ字→かな変換の確認が可能。"
  }
  </script>

  <meta name="theme-color" content="#0d6efd" />

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Hiragino Sans','Noto Sans CJK JP',sans-serif;background:#f0f2f5;color:#333;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:1em 0}
    .container{background:#fff;padding:2em;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);width:90%;max-width:880px}
    h1{text-align:center;margin-top:0;color:#007bff}
    p{text-align:center;color:#6c757d}
    .controls{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;justify-content:center;margin:.75rem 0 1rem}
    .controls label{font-weight:600}
    select,button{font-size:14px;padding:.5rem .75rem;border:1px solid #cbd3da;border-radius:8px;background:#fff}
    button{background:#0d6efd;color:#fff;border-color:#0d6efd;cursor:pointer}
    button:hover{filter:brightness(.95)}
    .display{display:flex;flex-direction:column;gap:1.5em;margin-bottom:1.5em}
    textarea{width:100%;box-sizing:border-box;padding:.5em;border:1px solid #ccc;border-radius:6px;font-size:1.4em;resize:none;background:#e9ecef}
    #keyboard{display:flex;flex-direction:column;gap:8px;margin-top:1em}
    .row{display:flex;justify-content:center;gap:8px;height:50px}
    .key{display:flex;justify-content:center;align-items:center;width:50px;height:100%;border:1px solid #ccc;border-bottom:3px solid #bbb;border-radius:6px;background:#fff;font-size:1.1em;font-weight:700;transition:all .07s ease;box-sizing:border-box;cursor:pointer;user-select:none}
    .key.space{width:300px}
    .key.active{background:#007bff;color:#fff;transform:translateY(2px);border-bottom:1px solid #0056b3}
    .key.waiting{outline:3px dashed #ff9800;background:#fff7e6;box-shadow:0 0 0 3px rgba(255,152,0,.2) inset}
    .status{margin-top:10px;text-align:center;color:#495057;font-size:.95em}
    .status strong{color:#d35400}
    kbd{background:#f1f3f5;border:1px solid #dee2e6;border-bottom-width:2px;border-radius:4px;padding:0 .35em}
    ul.sample{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.25rem 1rem;list-style:disc;padding-left:1.25rem}
    ul.sample li{white-space:nowrap}
  </style>
</head>
<body>
  <noscript>このツールを利用するにはJavaScriptを有効にしてください。</noscript>

  <div class="container">
    <h1>キーマッピング・かな変換テスター</h1>
    <p>物理キーボードで入力してください。<kbd>Backspace</kbd>で1文字削除、<kbd>Enter</kbd>でバッファをクリア。<br>
       キーの上書きは<strong>表示キーをクリック → 参照したい物理キーを押下</strong>（<kbd>Esc</kbd>でキャンセル）。</p>

    <!-- プリセット選択 -->
    <div class="controls" id="preset-controls" role="group" aria-label="プリセット選択">
      <label for="preset-select">プリセット：</label>
      <select id="preset-select" aria-label="キーボード配列プリセット">
        <option value="qwerty">QWERTY（既定）</option>
        <option value="dvorak">Dvorak（US）</option>
        <option value="onishi">大西（プレースホルダ）</option>
      </select>
      <button id="apply-preset" aria-label="プリセットを適用">適用</button>
    </div>

    <div class="display">
      <div class="textarea-container">
        <label for="romaji-input">ローマ字入力 (マッピング後)</label>
        <textarea id="romaji-input" rows="3" readonly></textarea>
      </div>
      <div class="textarea-container">
        <label for="kana-output">かな出力</label>
        <textarea id="kana-output" rows="3" readonly></textarea>
      </div>
    </div>

    <div id="keyboard" aria-label="仮想キーボード"></div>

    <!-- 使い方セクション（SEOにも効く説明テキスト） -->
    <section id="howto" aria-labelledby="howto-title">
      <h2 id="howto-title">使い方</h2>

      <h3>文字入力</h3>
      <ul>
        <li>物理キーボードでタイプすると、上の「ローマ字入力」「かな出力」に反映されます。</li>
        <li><kbd>Backspace</kbd>：1文字削除 ／ <kbd>Enter</kbd>：バッファをクリア</li>
      </ul>

      <h3>キー割り当ての上書き</h3>
      <ol>
        <li>キーレイアウトの<strong>変更したいキー</strong>をクリックします。</li>
        <li>参照したい<strong>物理キー</strong>を押下すると、そのキーの<strong>hook前（プレーン）文字</strong>で上書きされます。</li>
        <li>キャンセルは <kbd>Esc</kbd>。</li>
      </ol>

      <h3>プリセット</h3>
      <ul>
        <li><strong>QWERTY</strong>（既定）、<strong>Dvorak（US）</strong>、<strong>大西</strong>（プレースホルダ）から選択できます。</li>
        <li>「適用」を押すと、仮想キー表示と入力挙動が即時に更新されます。</li>
      </ul>

      <h3>補足</h3>
      <ul>
        <li>上書きは<strong>スワップではありません</strong>（クリックしたキーのみ変更）。</li>
        <li>US配列前提のキー名→文字対応です（例：<code>KeyD</code> → <code>d</code>、<code>Semicolon</code> → <code>;</code>、<code>Space</code> → 半角スペース）。</li>
      </ul>

      <h3>サンプル語句</h3>
      <ul class="sample">
        <li>おはよう</li><li>こんにちは</li><li>こんばんは</li><li>お疲れ様です</li><li>今何時</li>
        <li>お願いします</li><li>ありがとう</li><li>それください</li><li>せやな</li><li>なんで</li>
        <li>なに</li><li>いらない</li><li>猫に小判</li><li>馬の耳に念仏</li><li>七転び八起き</li>
      </ul>
    </section>

    <div id="remap-status" class="status" aria-live="polite"></div>
  </div>

  <script src="https://unpkg.com/wanakana"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const romajiInput = document.getElementById('romaji-input');
    const kanaOutput = document.getElementById('kana-output');
    const keyboardContainer = document.getElementById('keyboard');
    const remapStatus = document.getElementById('remap-status');

    const KEY_LAYOUT = [
      ['KeyQ','KeyW','KeyE','KeyR','KeyT','KeyY','KeyU','KeyI','KeyO','KeyP'],
      ['KeyA','KeyS','KeyD','KeyF','KeyG','KeyH','KeyJ','KeyK','KeyL','Semicolon'],
      ['KeyZ','KeyX','KeyC','KeyV','KeyB','KeyN','KeyM','Comma','Period'],
      ['Space']
    ];

    // --- プリセット定義 ---
    const PRESETS = {
      qwerty: {
        KeyQ:'q',KeyW:'w',KeyE:'e',KeyR:'r',KeyT:'t',KeyY:'y',KeyU:'u',KeyI:'i',KeyO:'o',KeyP:'p',
        KeyA:'a',KeyS:'s',KeyD:'d',KeyF:'f',KeyG:'g',KeyH:'h',KeyJ:'j',KeyK:'k',KeyL:'l',Semicolon:';',
        KeyZ:'z',KeyX:'x',KeyC:'c',KeyV:'v',KeyB:'b',KeyN:'n',KeyM:'m',Comma:',',Period:'.',
        Space:' '
      },
      // Dvorak（US）簡易対応（記号を含みます）
      dvorak: {
        KeyQ:"'", KeyW:",", KeyE:".", KeyR:'p', KeyT:'y', KeyY:'f', KeyU:'g', KeyI:'c', KeyO:'r', KeyP:'l',
        KeyA:'a', KeyS:'o', KeyD:'e', KeyF:'u', KeyG:'i', KeyH:'d', KeyJ:'h', KeyK:'t', KeyL:'n', Semicolon:'s',
        KeyZ:';', KeyX:'q', KeyC:'j', KeyV:'k', KeyB:'x', KeyN:'b', KeyM:'m', Comma:'w', Period:'v',
        Space:' '
      },
      // 大西（プレースホルダ）— 親指シフト等の同時打鍵は未実装
      onishi: {
        KeyQ:'q',KeyW:'w',KeyE:'e',KeyR:'r',KeyT:'t',KeyY:'y',KeyU:'u',KeyI:'i',KeyO:'o',KeyP:'p',
        KeyA:'a',KeyS:'s',KeyD:'d',KeyF:'f',KeyG:'g',KeyH:'h',KeyJ:'j',KeyK:'k',KeyL:'l',Semicolon:';',
        KeyZ:'z',KeyX:'x',KeyC:'c',KeyV:'v',KeyB:'b',KeyN:'n',KeyM:'m',Comma:',',Period:'.',
        Space:' '
      }
    };

    // 実際に使用する現在のマッピング
    const KEY_MAP = { ...PRESETS.qwerty }; // 既定はQWERTY

    // hook前（US基準）の素の文字を返す
    function rawCharFromCode(code){
      if (code.startsWith('Key') && code.length === 4) return code[3].toLowerCase(); // KeyA→'a'
      const special = { Semicolon:';', Comma:',', Period:'.', Space:' ' };
      return special[code] ?? null;
    }

    let romajiBuffer = '';
    let remapMode = false;
    let selectedCode = null;
    const keyElements = new Map();

    function createKeyboard(){
      KEY_LAYOUT.forEach(row => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row';
        row.forEach(code => {
          const keyDiv = document.createElement('div');
          keyDiv.className = 'key';
          if (code === 'Space') keyDiv.classList.add('space');
          keyDiv.textContent = KEY_MAP[code] ?? '';
          keyDiv.dataset.code = code;
          rowDiv.appendChild(keyDiv);
          keyElements.set(code, keyDiv);
        });
        keyboardContainer.appendChild(rowDiv);
      });
    }

    function updateKeyLabel(code){
      const el = keyElements.get(code);
      if (el) el.textContent = KEY_MAP[code] ?? '';
    }

    function updateAllKeyLabels(){ Object.keys(KEY_MAP).forEach(updateKeyLabel); }

    function setStatus(msg=''){ remapStatus.textContent = msg; }
    function cancelRemapVisual(){ keyElements.forEach(el => el.classList.remove('waiting')); }

    function startRemap(code){
      cancelRemapVisual();
      remapMode = true;
      selectedCode = code;
      const el = keyElements.get(code);
      if (el) el.classList.add('waiting');
      setStatus(`「${code}」の割り当てを上書きします。参照したい物理キーを押してください（Escでキャンセル）。`);
    }

    // 押した物理キーの hook前（プレーン）文字で selectedCode を上書き
    function applyOverride(fromCode){
      if (!selectedCode) { endRemap(); return; }
      const raw = rawCharFromCode(fromCode);
      if (!raw) { setStatus(`このキーは参照できません：${fromCode}（Escでキャンセル）`); return; }
      KEY_MAP[selectedCode] = raw; // 上書き
      updateKeyLabel(selectedCode);
      setStatus(`上書き完了：${selectedCode} ← '${raw}'（参照元: ${fromCode} の hook前文字）`);
      endRemap(true);
    }

    function endRemap(keepStatus=false){
      remapMode = false;
      selectedCode = null;
      cancelRemapVisual();
      if (!keepStatus) setStatus('');
    }

    // プリセット適用
    function applyPreset(name){
      const preset = PRESETS[name];
      if (!preset) return;
      for (const code of Object.keys(KEY_MAP)) {
        if (preset.hasOwnProperty(code)) KEY_MAP[code] = preset[code];
      }
      updateAllKeyLabels();
      setStatus(`プリセットを適用しました：${name}`);
    }

    // キー入力
    document.addEventListener('keydown', (e) => {
      e.preventDefault();
      const keyCode = e.code;
      const keyEl = keyElements.get(keyCode);
      if (keyEl) keyEl.classList.add('active');

      if (remapMode) {
        if (keyCode === 'Escape') { setStatus('上書きをキャンセルしました。'); endRemap(); return; }
        applyOverride(keyCode);
        return;
      }

      if (keyCode === 'Backspace') {
        romajiBuffer = romajiBuffer.slice(0, -1);
      } else if (keyCode === 'Enter') {
        romajiBuffer = '';
      } else if (KEY_MAP[keyCode] !== undefined) {
        romajiBuffer += KEY_MAP[keyCode];
      }

      romajiInput.value = romajiBuffer;
      kanaOutput.value = wanakana.toHiragana(romajiBuffer);
    });

    document.addEventListener('keyup', (e) => {
      const keyEl = keyElements.get(e.code);
      if (keyEl) keyEl.classList.remove('active');
    });

    keyboardContainer.addEventListener('click', (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      if (!t.classList.contains('key')) return;
      const code = t.dataset.code;
      if (!code) return;
      startRemap(code);
    });

    // UI: プリセット適用ボタン
    document.getElementById('apply-preset').addEventListener('click', () => {
      const name = document.getElementById('preset-select').value;
      applyPreset(name);
    });

    // 初期化
    createKeyboard();
    applyPreset('qwerty'); // 既定でQWERTYを明示適用
    setStatus('');
  });
  </script>
</body>
</html>
